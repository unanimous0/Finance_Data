# ğŸ“Š ë°ì´í„° ì ì¬ ê°€ì´ë“œ

> CSV íŒŒì¼ë¡œë¶€í„° ì „ì²´ ì‹œì¥ ë°ì´í„°ë¥¼ DBì— ì ì¬í•˜ëŠ” ë°©ë²•
>
> **ì‘ì„±ì¼**: 2026-02-19
> **ì ìš© ë²„ì „**: Python 3.12+, PostgreSQL 17 + TimescaleDB 2.25

---

## ğŸ“Œ ë¹ ë¥¸ ì‹œì‘

```bash
# ê°€ìƒí™˜ê²½ í™œì„±í™”
source venv/bin/activate

# ì „ì²´ ë°ì´í„° ì ì¬ (ì•½ 1ì‹œê°„ ì†Œìš”)
python scripts/load_all_data_from_csv.py

# ê²€ì¦
python -c "
import psycopg2
from config.settings import settings

conn = psycopg2.connect(
    host=settings.DB_HOST, port=settings.DB_PORT,
    dbname=settings.DB_NAME, user=settings.DB_USER, password=settings.DB_PASSWORD
)
cursor = conn.cursor()
cursor.execute('SELECT COUNT(*) FROM ohlcv_daily')
print(f'OHLCV: {cursor.fetchone()[0]:,}ê±´')
cursor.execute('SELECT COUNT(*) FROM market_cap_daily')
print(f'ì‹œê°€ì´ì•¡: {cursor.fetchone()[0]:,}ê±´')
cursor.execute('SELECT COUNT(*) FROM investor_trading')
print(f'íˆ¬ìì: {cursor.fetchone()[0]:,}ê±´')
conn.close()
"
```

---

## ğŸ“‚ ë°ì´í„° êµ¬ì¡°

### CSV íŒŒì¼ ìœ„ì¹˜
```
raw_data/temp/
â”œâ”€â”€ 1_ì‹œê°€.csv (19MB)
â”œâ”€â”€ 2_ê³ ê°€.csv (19MB)
â”œâ”€â”€ 3_ì €ê°€.csv (19MB)
â”œâ”€â”€ 4_í˜„ì¬ê°€.csv (19MB)
â”œâ”€â”€ 5_ê±°ë˜ëŸ‰.csv (19MB)
â”œâ”€â”€ 6_ê±°ë˜ëŒ€ê¸ˆ.csv (19MB)
â”œâ”€â”€ 7_ì‹œê°€ì´ì•¡.csv (21MB)
â”œâ”€â”€ 8_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ì™¸ì¸.csv (16MB)
â”œâ”€â”€ 9_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ê¸°ê´€ê³„.csv (18MB)
â”œâ”€â”€ 10_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ì—°ê¸°ê¸ˆ.csv (11MB)
â””â”€â”€ 11_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ê°œì¸.csv (22MB)
```

### CSV í˜•ì‹ (Pivot)
```csv
ì¼ì,ë™í™”ì•½í’ˆ,KRëª¨í„°ìŠ¤,ê²½ë°©,...(3,749ê°œ ì¢…ëª©)
2022-01-03,14800,2501,13750,...
2022-01-04,15000,2512,13750,...
...
2026-02-13,...
```

- **í–‰**: 1,009ê°œ (ë‚ ì§œ)
- **ì—´**: 3,750ê°œ (ì¼ì + 3,749ê°œ ì¢…ëª©ëª…)
- **ê¸°ê°„**: 2022-01-03 ~ 2026-02-13 (ì•½ 4ë…„)

### DB í…Œì´ë¸” (ì •ê·œí™”)
```sql
-- OHLCV ì¼ë´‰
CREATE TABLE ohlcv_daily (
    time DATE NOT NULL,
    stock_code VARCHAR(6) NOT NULL,
    open_price INTEGER,
    high_price INTEGER,
    low_price INTEGER,
    close_price INTEGER,
    volume BIGINT,
    trading_value BIGINT,
    PRIMARY KEY (time, stock_code)
);

-- ì‹œê°€ì´ì•¡
CREATE TABLE market_cap_daily (
    time DATE NOT NULL,
    stock_code VARCHAR(6) NOT NULL,
    market_cap BIGINT,
    PRIMARY KEY (time, stock_code)
);

-- íˆ¬ììë³„ ìˆœë§¤ìˆ˜
CREATE TABLE investor_trading (
    time DATE NOT NULL,
    stock_code VARCHAR(6) NOT NULL,
    investor_type VARCHAR(20) NOT NULL,
    net_buy_value BIGINT,
    PRIMARY KEY (time, stock_code, investor_type)
);
```

---

## ğŸ”„ ë°ì´í„° ë§¤í•‘

### 11ê°œ CSV â†’ 3ê°œ í…Œì´ë¸”

| CSV íŒŒì¼ | ëŒ€ìƒ í…Œì´ë¸” | ì»¬ëŸ¼ |
|----------|------------|------|
| 1_ì‹œê°€.csv | ohlcv_daily | open_price |
| 2_ê³ ê°€.csv | ohlcv_daily | high_price |
| 3_ì €ê°€.csv | ohlcv_daily | low_price |
| 4_í˜„ì¬ê°€.csv | ohlcv_daily | close_price |
| 5_ê±°ë˜ëŸ‰.csv | ohlcv_daily | volume |
| 6_ê±°ë˜ëŒ€ê¸ˆ.csv | ohlcv_daily | trading_value |
| 7_ì‹œê°€ì´ì•¡.csv | market_cap_daily | market_cap |
| 8_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ì™¸ì¸.csv | investor_trading | FOREIGN |
| 9_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ê¸°ê´€ê³„.csv | investor_trading | INSTITUTION |
| 10_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ì—°ê¸°ê¸ˆ.csv | investor_trading | PENSION |
| 11_ìˆœë§¤ìˆ˜ê±°ë˜ëŒ€ê¸ˆ_ê°œì¸.csv | investor_trading | RETAIL |

### ë³€í™˜ ê³¼ì •

```
[Pivot CSV]                    [ì •ê·œí™”]
ì¼ì, ë™í™”ì•½í’ˆ, ì‚¼ì„±ì „ì   â†’   time, stock_code, value
2022-01-03, 14800, 80000  â†’   2022-01-03, 000020, 14800
                          â†’   2022-01-03, 005930, 80000
```

---

## ğŸ“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„¸

### scripts/load_all_data_from_csv.py

#### ì£¼ìš” í•¨ìˆ˜

**1. get_stock_mapping()**
- DBì˜ stocks í…Œì´ë¸”ì—ì„œ ì¢…ëª©ëª… â†’ ì¢…ëª©ì½”ë“œ ë§¤í•‘ ë¡œë“œ
- ë°˜í™˜: `{"ë™í™”ì•½í’ˆ": "000020", "ì‚¼ì„±ì „ì": "005930", ...}`

**2. load_csv_pivot_to_list(file_path, stock_mapping)**
- CSV íŒŒì¼ ì½ê¸° (Pivot í˜•ì‹)
- `pd.melt()`ë¡œ ì •ê·œí™” ë³€í™˜
- ì¢…ëª©ëª… â†’ ì¢…ëª©ì½”ë“œ ë§¤í•‘
- ë°˜í™˜: `[{"date": date, "stock_code": "000020", "value": 14800}, ...]`

**3. load_ohlcv_data(stock_mapping, temp_folder)**
- 6ê°œ CSV íŒŒì¼ ì½ê¸° (ì‹œê°€/ê³ ê°€/ì €ê°€/í˜„ì¬ê°€/ê±°ë˜ëŸ‰/ê±°ë˜ëŒ€ê¸ˆ)
- ê° íŒŒì¼ì˜ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ê²°í•©
- ohlcv_daily í…Œì´ë¸”ì— bulk insert
- ON CONFLICT DO UPDATE ì‚¬ìš© (ì¤‘ë³µ ë°ì´í„° ë°©ì§€)

**4. load_market_cap_data(stock_mapping, temp_folder)**
- 1ê°œ CSV íŒŒì¼ ì½ê¸° (ì‹œê°€ì´ì•¡)
- market_cap_daily í…Œì´ë¸”ì— insert

**5. load_investor_data(stock_mapping, temp_folder)**
- 4ê°œ CSV íŒŒì¼ ì½ê¸° (ì™¸ì¸/ê¸°ê´€ê³„/ì—°ê¸°ê¸ˆ/ê°œì¸)
- investor_type ì¶”ê°€
- investor_trading í…Œì´ë¸”ì— insert

#### ì„±ëŠ¥ ìµœì í™” í¬ì¸íŠ¸

**í•µì‹¬: df.melt() ì‚¬ìš©**
```python
# âŒ ëŠë¦° ë°©ì‹ (30ë¶„+)
for idx, row in df.iterrows():
    for stock_name in df.columns[1:]:
        value = row[stock_name]
        # ì²˜ë¦¬...

# âœ… ë¹ ë¥¸ ë°©ì‹ (5-7ì´ˆ)
df_melted = df.melt(
    id_vars=[date_col],
    var_name='stock_name',
    value_name='value'
)
# ë²¡í„°í™” ì—°ì‚°ìœ¼ë¡œ í•œ ë²ˆì— ì²˜ë¦¬
```

**ê²°ê³¼**: 300ë°° ì´ìƒ ì†ë„ í–¥ìƒ (30ë¶„+ â†’ 5ì´ˆ)

---

## â±ï¸ ì†Œìš” ì‹œê°„

### ì „ì²´ í”„ë¡œì„¸ìŠ¤ (60.8ë¶„)

| ë‹¨ê³„ | ì†Œìš” ì‹œê°„ | ë¹„ê³  |
|------|----------|------|
| ì¢…ëª© ë§¤í•‘ ë¡œë“œ | < 1ì´ˆ | 3,820ê°œ ì¢…ëª© |
| 6ê°œ OHLCV CSV ì½ê¸° | 40ì´ˆ | ê° 5-7ì´ˆ |
| OHLCV DB ì‚½ì… (3.26Mê±´) | 9ë¶„ | 36ë§Œê±´/ë¶„ |
| ì‹œê°€ì´ì•¡ CSV ì½ê¸° | 6ì´ˆ | - |
| ì‹œê°€ì´ì•¡ DB ì‚½ì… (3.26Mê±´) | 9ë¶„ | 36ë§Œê±´/ë¶„ |
| 4ê°œ íˆ¬ìì CSV ì½ê¸° | 30ì´ˆ | ê° 6-9ì´ˆ |
| íˆ¬ìì DB ì‚½ì… (13Mê±´) | 41ë¶„ | 32ë§Œê±´/ë¶„ |
| **í•©ê³„** | **60.8ë¶„** | - |

### ìµœì í™” ì „ vs í›„

| í•­ëª© | ìµœì í™” ì „ | ìµœì í™” í›„ | ê°œì„ ìœ¨ |
|------|----------|----------|--------|
| ì²« CSV íŒŒì¼ ì½ê¸° | 30ë¶„+ | 5ì´ˆ | **360ë°°** |
| ì „ì²´ ì˜ˆìƒ ì‹œê°„ | 5.5ì‹œê°„+ | 60.8ë¶„ | **5.4ë°°** |

---

## âœ… ê²€ì¦ ë°©ë²•

### 1. ë ˆì½”ë“œ ìˆ˜ í™•ì¸
```sql
SELECT COUNT(*) FROM ohlcv_daily;       -- 3,257,951
SELECT COUNT(*) FROM market_cap_daily;  -- 3,257,951
SELECT COUNT(*) FROM investor_trading;  -- 13,031,804
```

### 2. ë‚ ì§œ ë²”ìœ„ í™•ì¸
```sql
SELECT MIN(time), MAX(time) FROM ohlcv_daily;
-- ê²°ê³¼: 2022-01-03 ~ 2026-02-13
```

### 3. ì¢…ëª© ìˆ˜ í™•ì¸
```sql
SELECT COUNT(DISTINCT stock_code) FROM ohlcv_daily;
-- ê²°ê³¼: 3,726ê°œ
```

### 4. íˆ¬ìì íƒ€ì… í™•ì¸
```sql
SELECT investor_type, COUNT(*)
FROM investor_trading
GROUP BY investor_type
ORDER BY investor_type;

-- ê²°ê³¼:
-- FOREIGN: 3,257,951
-- INSTITUTION: 3,257,951
-- PENSION: 3,257,951
-- RETAIL: 3,257,951
```

### 5. ìƒ˜í”Œ ë°ì´í„° í™•ì¸
```sql
-- ì‚¼ì„±ì „ì ìµœê·¼ 10ì¼
SELECT time, close_price, volume
FROM ohlcv_daily
WHERE stock_code = '005930'
ORDER BY time DESC
LIMIT 10;
```

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: ON CONFLICT ì—ëŸ¬

**ì¦ìƒ**:
```
there is no unique or exclusion constraint matching the ON CONFLICT specification
```

**ì›ì¸**: PRIMARY KEY ë¯¸ì„¤ì •

**í•´ê²°**:
```sql
ALTER TABLE ohlcv_daily ADD PRIMARY KEY (time, stock_code);
ALTER TABLE market_cap_daily ADD PRIMARY KEY (time, stock_code);
ALTER TABLE investor_trading ADD PRIMARY KEY (time, stock_code, investor_type);
```

### ë¬¸ì œ 2: ë§¤ìš° ëŠë¦° ì‹¤í–‰ ì†ë„

**ì¦ìƒ**: ì²« CSV íŒŒì¼ ì½ê¸°ì— 30ë¶„ ì´ìƒ ì†Œìš”

**ì›ì¸**: `df.iterrows()` ì‚¬ìš© (ë¹„íš¨ìœ¨ì )

**í•´ê²°**: ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì´ë¯¸ `df.melt()` ì‚¬ìš© ì¤‘ (ìµœì í™” ì™„ë£Œ)

### ë¬¸ì œ 3: ë©”ëª¨ë¦¬ ë¶€ì¡±

**ì¦ìƒ**: ëŒ€ìš©ëŸ‰ CSV íŒŒì¼ ì½ê¸° ì‹œ ë©”ëª¨ë¦¬ ì—ëŸ¬

**í•´ê²°**: í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” chunk ë‹¨ìœ„ ì²˜ë¦¬ ë¶ˆí•„ìš” (19MB Ã— 11ê°œ)

**í–¥í›„**: ë” í° íŒŒì¼ ì²˜ë¦¬ì‹œ `pd.read_csv(chunksize=10000)` ê³ ë ¤

### ë¬¸ì œ 4: ë¯¸ë§¤ì¹­ ì¢…ëª©

**ì¦ìƒ**: 23ê°œ ì¢…ëª©ì´ stocks í…Œì´ë¸”ì— ì—†ìŒ

**ì›ì¸**:
- CSV íŒŒì¼: ê³¼ê±° ìƒì¥ëœ ì¢…ëª© í¬í•¨ (ìƒì¥íì§€ í¬í•¨)
- stocks í…Œì´ë¸”: í˜„ì¬ ìƒì¥ ì¢…ëª©ë§Œ í¬í•¨

**í•´ê²°**:
- ë¬´ì‹œ: ìƒì¥íì§€ ì¢…ëª©ì€ ìŠ¤í‚µ (í˜„ì¬ ë°©ì‹)
- ë˜ëŠ”: stocks í…Œì´ë¸”ì— ê³¼ê±° ìƒì¥íì§€ ì¢…ëª© ì¶”ê°€

---

## ğŸ“Œ ì¬ì ì¬ ë°©ë²•

### ì „ì²´ ë°ì´í„° ì¬ì ì¬

```bash
# 1. ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
psql -d korea_stock_data -c "TRUNCATE ohlcv_daily;"
psql -d korea_stock_data -c "TRUNCATE market_cap_daily;"
psql -d korea_stock_data -c "TRUNCATE investor_trading;"

# 2. ì¬ì ì¬
source venv/bin/activate
python scripts/load_all_data_from_csv.py

# 3. ê²€ì¦
python scripts/verify_data.py  # (ì‘ì„± ì˜ˆì •)
```

### ì¦ë¶„ ì—…ë°ì´íŠ¸

í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì „ì²´ ì¬ì ì¬ìš©ì…ë‹ˆë‹¤.

**í–¥í›„ ê°œì„  ì‚¬í•­**:
- ì¼ë³„ ì¦ë¶„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ ì¶”ê°€
- API ì—°ë™ìœ¼ë¡œ ìµœì‹  ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸

---

## ğŸš€ í–¥í›„ ê°œì„  ì‚¬í•­

1. **ì¦ë¶„ ì—…ë°ì´íŠ¸**
   - ìµœì‹  ë‚ ì§œ í™•ì¸ í›„ ì‹ ê·œ ë°ì´í„°ë§Œ ì ì¬
   - API ì—°ë™ìœ¼ë¡œ ì¼ë³„ ìë™ ì—…ë°ì´íŠ¸

2. **ë³‘ë ¬ ì²˜ë¦¬**
   - 11ê°œ CSV íŒŒì¼ì„ ë³‘ë ¬ë¡œ ì½ê¸°
   - multiprocessing í™œìš©

3. **ì—ëŸ¬ ë³µêµ¬**
   - ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§
   - ë¶€ë¶„ ì‹¤íŒ¨ ì‹œ ì²´í¬í¬ì¸íŠ¸ ì €ì¥

4. **ëª¨ë‹ˆí„°ë§**
   - data_collection_logs í…Œì´ë¸” í™œìš©
   - ì ì¬ ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸

---

**ì‘ì„±ì**: Claude Sonnet 4.5
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2026-02-19
